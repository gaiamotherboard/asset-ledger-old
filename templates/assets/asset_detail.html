{% extends "base.html" %}

{% block title %}Asset {{ asset.asset_tag|default:asset.id }} - Asset Control Panel{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-4 space-y-4">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h</div>1 class="text-2xl font-bold">
        Asset {{ hw.intake.asset_id|default:asset.asset_tag|default:asset.id }}
      </h1>
      <div class="text-sm opacity-70">
        {{ hw.scan.generated_at|default:"—" }} · {{ hw.scan.scanner|default:"—" }}
      </div>
    </div>

    <div class="flex gap-2">
      <a class="btn btn-sm btn-outline" href="/admin/assets/asset/{{ asset.id }}/change/">Edit Intake</a>
      <a class="btn btn-sm btn-primary" href="#upload">Upload</a>
      <a class="btn btn-sm btn-ghost" href="#bulk-upload">Bulk Upload</a>
    </div>
  </div>

  {% if not hw.scan.generated_at or hw.scan.generated_at == "—" %}
  <div class="alert alert-info shadow">
    <span>No scan data yet for this asset.</span>
  </div>
  {% endif %}

  <!-- Intake -->
  <div class="card bg-base-100 shadow">
    <div class="card-body p-4">
      <h2 class="card-title text-lg">Intake</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 text-sm">
        <div></div>
          <div class="text-xs opacity-60">Asset ID</div>
          <div class="font-semibold">{{ hw.intake.asset_id|default:"—" }}</div>
        </div>
        <div>
          <div class="</div>text-xs opacity-60">Tech</div>
          <div class="font-semibold">{{ hw.intake.tech_name|default:"—" }}</div>
        </div>
        <div></div>
          <div class="text-xs opacity-60">Client</div>
          <div class="font-semibold">{{ hw.intake.client_name|default:"—" }}</div>
        </div>
        <div></div>
          <div class="text-xs opacity-60">Cosmetic</div>
          <div class="font-semibold">{{ hw.intake.cosmetic_condition|default:"—" }}</div>
        </div>
      </div>

      {% if hw.intake.note %}
      <div class="mt-3">
        <div class="text-xs opacity-60">Note</div>
        <div class="text-sm whitespace-pre-wrap">{{ hw.intake.note }}</div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Bulk Upload -->
  <div id="bulk-upload" class="card bg-base-100 shadow">
    <div class="card-body p-4">
      <h2 class="card-title text-lg">Bulk Upload Scan Bundles</h2>
      <p class="text-sm opacity-70">
        Upload multiple JSON files at once. Each filename must be
        <span class="font-mono">ASSETTAG.json</span> and the JSON must contain
        <span class="font-mono">intake.asset_id</span> matching the filename.
      </p>

      <form method="post" action="{% url 'asset_scan_bulk_upload' %}" enctype="multipart/form-data" class="mt-3 space-y-3">
        {% csrf_token %}
        <input
          type="file"
          name="files"
          multiple
          accept=".json,application/json"
          class="file-input file-input-bordered w-full"
        />
        <div class="flex flex-wrap gap-2">
          <button type="submit" class="btn btn-primary">Upload Files</button>
          <a class="btn btn-ghost" href="#upload">Single Upload</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Specs (4×2 responsive grid) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">CPU</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.cpu.model|default:"—" }}</div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-xs opacity-60">Max</div>
          <span class="badge badge-ghost">{{ hw.cpu.max|default:"—" }}</span>
        </div>
        {% if hw.cpu.microcode %}
        <div class="mt-1 text-xs opacity-70">Microcode: {{ hw.cpu.microcode }}</div>
        {% endif %}
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">RAM</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.ram.total|default:"—" }}</div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">GPU</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.gpu.model|default:"—" }}</div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-xs opacity-60">Driver</div>
          <span class="badge badge-ghost">{{ hw.gpu.driver|default:"—" }}</span>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">Display</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.display.panel|default:"—" }}</div>
        <div class="mt-2 text-sm opacity-80">{{ hw.display.native|default:"—" }}</div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">Battery</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.battery.model|default:"—" }}</div>
        <div class="mt-2 text-sm opacity-80">{{ hw.battery.health|default:"—" }}</div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">Wi‑Fi</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.wifi.model|default:"—" }}</div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-xs opacity-60">Driver</div>
          <span class="badge badge-ghost">{{ hw.wifi.driver|default:"—" }}</span>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">Ethernet</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.ethernet.model|default:"—" }}</div>
        <div class="mt-2 text-xs opacity-80">
          IF: {{ hw.ethernet.ifname|default:"—" }}<br>
          MAC: {{ hw.ethernet.mac|default:"—" }}
        </div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-xs opacity-60">Driver</div>
          <span class="badge badge-ghost">{{ hw.ethernet.driver|default:"—" }}</span>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body p-4">
        <div class="text-xs opacity-60">Thunderbolt</div>
        <div class="font-semibold text-sm leading-snug">{{ hw.thunderbolt.model|default:"—" }}</div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-xs opacity-60">Driver</div>
          <span class="badge badge-ghost">{{ hw.thunderbolt.driver|default:"—" }}</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Scan Health -->
  <div class="card bg-base-100 shadow">
    <div class="card-body p-4">
      <h2 class="card-title text-lg">Scan Health</h2>

      <div class="text-sm opacity-70">
        Generated: {{ hw.scan.generated_at|default:"—" }}<br>
        Scanner: {{ hw.scan.scanner|default:"—" }}
      </div>

      <div class="mt-3 overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Tool</th</thead></tr>>
              <th>RC</th></th></th>
              <th>St</th>derr (first line)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in hw.scan.health_rows %}
            <tr></tbody></tr>
              <td class="font-mono">{{ r.tool|default:"—" }}</td>
              <td>{{ r.rc|default:"—" }}</td>
              <td class="opacity-80">{{ r.stderr|default:"" }}</td>
            </tr>
            {% empty %}
            <tr></tr>
              <td colspan="3" class="opacity-70">—</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Upload (single) -->
  <div id="upload" class="card bg-base-100 shadow">
    <div class="card-body p-4">
      <h2 class="card-title text-lg">Upload Scan Bundle</h2>

      <form method="post" action="{% url 'asset_scan_upload' asset.asset_tag %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="mt-2">
          <label class="label">
            <span class="label-text font-semibold">Scan bundle JSON file (motherboard.scan_bundle.v1)</span>
          </label>
          {{ upload_form.file }}
        </div>

        <div class="mt-2">
          <label class="label">
            <span class="label-text font-semibold">Notes (optional)</span>
          </label>
          {{ upload_form.user_notes }}
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-success">Upload</button>
        </div>
      </form>

    </div>
  </div>

</div>
{% endblock %}
